在第 5 章 “内存架构与数据局部性” 中，我们研究了利用共享内存来减少每个线程块中的一组线程必须从全局内存访问的数据总量的分块技术。在本章中，我们将进一步讨论以高效方式在全局内存与共享内存或寄存器之间移动数据的内存合并技术。内存合并技术通常与分块技术结合使用，以使 CUDA 设备通过有效利用全局内存带宽来发挥其性能潜力。

图 6.3 说明了当矩阵以列主顺序存储时，连续线程如何遍历连续列。图 6.3 的左上部分显示了代码，右上部分显示了内存访问的逻辑视图。程序仍在尝试让每个线程访问矩阵 M 的一列。通过检查代码可以看出对 M 的访问不利于合并。数组 M 的索引是 colWidth+k。和以前一样，col 被定义为 block Idx. xblock Dim.x+threadIdx.x，这意味着连续线程（具有连续的 threadIdx.x 值）将具有连续的 col 值。但是，在 M 的索引中，col 乘以 Width，这意味着连续线程将访问 M 中 Width 相距的元素。因此访问不利于合并。


![img.png](img.png)

这个图也解释了 第三章的exercise 的练习题 第一题 


内存合并的主要优点是，它通过将多个内存访问合并为单个访问来减少全局内存流量。访问可以在同时发生时进行组合，并访问相邻的内存位置。交通拥堵不仅仅出现在计算中。我们大多数人都经历过高速公路系统中的交通拥堵，如图 6.5 所示。高速公路交通拥堵的根本原因是有太多的汽车都试图在为更少数量的车辆设计的道路上行驶。当拥堵发生时，每辆车的行驶时间大大增加。当交通拥堵时，通勤上班时间很容易增加一倍或三倍。
大多数减少交通拥堵的解决方案都包括减少路上的汽车数量。假设通勤者的数量不变，人们需要共享乘车，以减少路上的汽车数量。共享乘车的一种常见方式是拼车，即一群通勤者的成员轮流驾驶一辆车去上班。政府通常需要制定鼓励拼车的政策。在一些国家，政府简单地禁止某些类别的汽车每天上路。例如，周一、周三或周五可能不允许车牌号为奇数的汽车上路。这鼓励那些在不同日子允许汽车的人组成拼车团体。在其他国家，政府可能会为减少汽车数量的行为提供激励道路。例如，在某些国家，拥挤的高速公路的一些车道被指定为拼车车道；只有两三个人以上的汽车才被允许使用这些车道。还有一些国家，政府使汽油变得如此昂贵，以至于人们为了省钱而组成拼车。

![img_1.png](img_1.png)

