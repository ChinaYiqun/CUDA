## 6.2 隐藏内存延迟

在第6.1节中，我们解释了DRAM突发传输是一种并行组织形式：多个位置在DRAM核心阵列中并行访问。然而，仅靠突发传输本身并不足以实现现代处理器所需的DRAM访问带宽水平。DRAM系统通常采用两种并行组织形式：bank和channel。在最高级别，处理器包含一个或多个channel。每个channel是一个内存控制器，有一个总线连接一组DRAM bank到处理器。图6.7展示了一个包含四个channel的处理器，每个channel都有一个连接四个DRAM bank的总线。

总线的传输带宽由其宽度和时钟频率定义。现代双倍数据速率（DDR）总线每个时钟周期执行两次数据传输：一次在每个时钟周期的上升沿，一次在下降沿。例如，一个64位DDR总线，时钟频率为1 GHz，带宽为8B*2*1GHz=16GB/s。这似乎是一个大数字，但对于现代CPU和GPU来说，这通常太小。现代CPU可能需要至少32GB/s的内存带宽，而现代GPU可能需要256GB/s。对于这个例子，CPU需要2个channel，GPU需要16个channel。

对于每个channel，连接到它的bank数量由充分利用总线的传输带宽所需的bank数量决定。这在图6.8中有所说明。每个bank包含一个DRAM单元阵列、访问这些单元的感应放大器，以及将突发数据传输到总线的接口（第6.1节）。

总线的数据传输时间由其宽度和时钟频率定义。现代双倍数据速率（DDR）总线每个时钟周期执行两次数据传输：一次在每个时钟周期的上升沿，一次在下降沿。例如，一个64位DDR总线，时钟频率为1GHz，带宽为8B*2*1GHz=16GB/s。这似乎是一个大数字，但对于现代CPU和GPU来说，这通常太小。现代CPU可能需要至少32GB/s的内存带宽，而现代GPU可能需要256GB/s。对于这个例子，CPU需要2个channel，GPU需要16个channel。

对于每个channel，连接到它的bank数量由充分利用总线的传输带宽所需的bank数量决定。这在图6.8中有所说明。每个bank包含一个DRAM单元阵列、访问这些单元的感应放大器，以及将突发数据传输到总线的接口（第6.1节）。

总线的传输带宽由其宽度和时钟频率定义。现代双倍数据速率（DDR）总线每个时钟周期执行两次数据传输：一次在每个时钟周期的上升沿，一次在下降沿。例如，一个64位DDR总线，时钟频率为1GHz，带宽为8B*2*1GHz=16GB/s。这似乎是一个大数字，但对于现代CPU和GPU来说，这通常太小。现代CPU可能需要至少32GB/s的内存带宽，而现代GPU可能需要256GB/s。对于这个例子，CPU需要2个channel，GPU需要16个channel。

对于每个channel，连接到它的bank数量由充分利用总线的传输带宽所需的bank数量决定。这在图6.8中有所说明。每个bank包含一个DRAM单元阵列、访问这些单元的感应放大器，以及将突发数据传输到总线的接口（第6.1节）。

在图6.9中，展示了将数组元素分布到通道和bank的分布方案。我们假设一个小突发大小为两个元素（8字节）。分布是由硬件设计完成的。通道和bank的寻址方式是这样的，数组的前8个字节（M[0]和M[1]）存储在通道0的bank0中，接下来的8字节（M[2]和M[3]）在通道1的bank0中，接下来的8字（M[4]和M[5]）在通道2的bank0中，接下来的8字（M[6]和M[7]）在通道3的bank0中。

在这一点上，分布回到图6.8，我们可以看到，通过拥有两个bank，我们可以潜在地将通道总线的传输带宽利用率翻倍。一般来说，如果单元阵列访问延迟和数据传输时间的比率是R，我们需要至少R+1个bank，如果我们希望充分利用通道总线的传输带宽。例如，如果比率是20，我们将需要至少21个连接到每个通道总线的bank。总的来说，连接到每个通道总线的bank数量需要大于R，原因有两个。一是拥有更多的bank可以减少多个同时访问同一bank的概率，这种现象称为bank冲突。由于每个bank一次只能服务一个访问，单元阵列访问延迟不能再为这些冲突访问重叠。拥有更多的bank增加了这些访问将被分散到多个bank的概率。第二个原因是，每个单元阵列的大小被设置为实现合理的延迟和可制造性。这限制了每个bank可以提供的单元数量。可能需要很多bank来支持所需的内存大小。

在图6.9中，展示了将数组M的元素分布到通道和bank的示例。我们假设一个较小的突发大小为两个元素（8字节）。分布是由硬件设计完成的。通道和bank的寻址方式是这样的，数组的前8个字节（M[0]和M[1]）存储在通道0的bank0中，接下来的8字节（M[2]和M[3]）存储在通道1的bank0中，接下来的8字节（M[4]和M[5]）存储在通道2的bank0中，接下来的8字（M[6]和M[7]）存储在通道3的bank0中。

在这一点上，分布回到图6.8，我们可以看到，通过拥有两个bank，我们可以潜在地将通道总线的传输带宽利用率翻倍。一般来说，如果单元阵列访问延迟和数据传输时间的比率是R，我们需要至少R+1个bank，如果我们希望充分利用通道总线的传输带宽。例如，如果比率是20，我们将需要至少21个连接到每个通道总线的bank。总的来说，连接到每个通道总线的bank数量需要大于R，原因有两个。一是拥有更多的bank可以减少多个同时访问同一bank的概率，这种现象称为bank冲突。由于每个bank一次只能服务一个访问，单元阵列访问延迟不能再为这些冲突重叠。拥有更多的bank增加了这些访问将被分散到多个bank的概率。第二个原因是，每个单元阵列的大小被设置为实现合理的延迟和可制造性。这限制了每个bank可以提供的单元数量。可能需要很多bank来支持所需的内存大小。

在图6.9中，展示了将数组元素分布到通道和bank的示例。我们假设一个较小的突发大小为两个元素（8字节）。分布是由硬件设计完成的。通道和bank的寻址方式是这样的，数组的前8个字节（M[0]和M[1]）存储在通道0的bank0中，接下来的8字节（M[2]和M[3]）存储在通道1的bank0中，接下来的8字节（M[4]和M[5]）存储在通道2的bank0中，接下来的8字节（M[6]和M[7]）存储在通道3的bank0中。

在这一点上，分布回到图6.8，我们可以看到，通过拥有两个bank，我们可以潜在地将通道总线的传输带宽利用率翻倍。一般来说，如果单元阵列访问延迟和数据传输时间的比率是R，我们需要至少R+1个bank，如果我们希望充分利用通道总线的传输带宽。例如，如果比率是20，我们将需要至少21个连接到每个通道总线的bank。总的来说，连接到每个通道总线的bank数量需要大于R，原因有两个。一是拥有更多的bank可以减少多个同时访问同一bank的概率，这种现象称为bank冲突。由于每个bank一次只能服务一个访问，单元阵列访问延迟不能再为这些冲突重叠。拥有更多的bank增加了这些访问将被分散到多个bank的概率。第二个原因是，每个单元阵列的大小被设置为实现合理的延迟和可制造性。这限制了每个bank可以提供的单元数量。可能需要很多bank来支持所需的内存大小。

在图6.9中，展示了将数组元素分布到通道和bank的示例。我们假设一个较小的突发大小为两个元素（8字节）。分布是由硬件设计完成的。通道和bank的寻址方式是这样的，数组的前8个字节（M[0]和M[1]）存储在通道0的bank0中，接下来的8字节（M[2]和M[3]）存储在通道1的bank0中，接下来的8字节（M[4]和M[5]）存储在通道2的bank0中，接下来的8字节（M[6]和M[7]）存储在通道3的bank0中。

在这一点上，分布回到图6.8，我们可以看到，通过拥有两个bank，我们可以潜在地将通道总线的传输带宽利用率翻倍。一般来说，如果单元阵列访问延迟和数据传输时间的比率是R，我们需要至少R+1个bank，如果我们希望充分利用通道总线的传输带宽。例如，如果比率是20，我们将需要至少21个连接到每个通道总线的bank。总的来说，连接到每个通道总线的bank数量需要大于R，原因有两个。一是拥有
